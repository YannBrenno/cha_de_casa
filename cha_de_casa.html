<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chá de Casa Nova - Camila & Yann</title>
<style>
  :root{
    --bg:#fafafa; --card:#fff; --muted:#6b7280; --accent:#0d9488;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background:var(--bg);
    color:#111;
    padding:14px;
    -webkit-font-smoothing:antialiased;
  }

  header{ text-align:center; margin-bottom:12px }
  header h1{ margin:0; font-size:20px; font-weight:700 }
  header p{ margin:4px 0 0 0; color:var(--muted); font-size:13px }

  /* mobile single-column */
  #lista{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }

  .card{
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:0 6px 18px rgba(12,15,20,0.06);
    padding:12px;
    overflow:hidden;
  }
  
#contador span{
  cursor:pointer;
  transition:.2s;
}

#contador span.active{
  background:var(--accent);
  color:white;
}

#contador span.active b{
  color:white;
}

.img-box{
  width:110px;
  height:110px;
  border-radius:50%;
  overflow:hidden;
  margin:0 auto; /* centraliza */
  background:#f3f3f3;
  display:flex;
  align-items:center;
  justify-content:center;
}

.img-box img{
  width:100%;
  height:100%;
  object-fit:contain; /* exibe a imagem completa */
  display:block;
}

  .row { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px; }
  .title { font-weight:700; font-size:16px; }
  .qty { color:var(--muted); font-size:13px; }

  .buyers { margin-top:8px; color:#333; font-size:13px; line-height:1.2; }
  .btn { width:100%; display:block; padding:12px; border-radius:10px; background:var(--accent); color:white; text-align:center; font-weight:700; margin-top:10px; }

  .card.esgotado{ filter:grayscale(1) brightness(.9); opacity:.7 }
  .card .btn.disabled{ background:#cbd5e1; cursor:not-allowed; }

  /* modal */
  #modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); padding:16px; z-index:9999 }
  #modal .box{ width:100%; max-width:420px; background:white; border-radius:12px; padding:16px; box-shadow:0 25px 60px rgba(2,6,23,0.3) }
  .input{ width:100%; padding:12px; border-radius:10px; border:1px solid #e6e9ee; margin-top:8px; font-size:15px }
  .row-buttons{ display:flex; gap:8px; margin-top:12px }
  .btn-secondary{ flex:1; background:#f3f4f6; color:#111; border-radius:10px; padding:10px; text-align:center; font-weight:700 }

  /* small helper */
  .muted{ color:var(--muted); font-size:13px }

  #contador{
  margin-top:8px;
  display:flex;
  justify-content:center;
  gap:14px;
  font-size:13px;
  color:var(--muted);
  flex-wrap:wrap;
}

#contador span{
  background:#fff;
  padding:6px 10px;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(12,15,20,0.06);
}

#contador b{
  color:#111;
}

</style>
</head>
<body>

<header>
  <h1>Chá de Casa Nova</h1>
  <p>Camila &amp; Yann</p>

<div id="contador">
  <span data-filter="todos" class="filtro ativo">
    <strong>Total:</strong> <b id="total-itens">0</b>
  </span>
  <span data-filter="reservados" class="filtro">
    <strong>Reservados:</strong> <b id="itens-reservados">0</b>
  </span>
  <span data-filter="disponiveis" class="filtro">
    <strong>Disponíveis:</strong> <b id="itens-disponiveis">0</b>
  </span>
</div>

</header>


<main>
  <div id="lista"></div>
  <div id="status" style="text-align:center;margin-top:10px;color:var(--muted);font-size:13px"></div>
</main>

<!-- Modal -->
<div id="modal">
  <div class="box" role="dialog" aria-modal="true">
    <div style="font-weight:800;font-size:16px" id="modal-title">Presentear</div>
    <div class="muted" id="modal-sub" style="margin-top:6px">Descrição</div>

    <label style="margin-top:12px;display:block;font-weight:700;font-size:13px">Seu nome</label>
    <input id="input-name" class="input" placeholder="Ex: Camila">

    <label style="margin-top:6px;display:block;font-weight:700;font-size:13px">Quantidade</label>
    <input id="input-qtd" class="input" type="number" min="1" value="1">

    <div class="row-buttons">
      <div id="confirm-btn" class="btn" style="flex:1">Confirmar</div>
      <div id="cancel-btn" class="btn-secondary" style="flex:1">Cancelar</div>
    </div>
  </div>
</div>

<script>
/* ===================
   CONFIG
   =================== */
// sua URL do WebApp (já publicada)
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxV7z8tTo54SrDHuNjufFf4JDp2RDv_NfBk8KStYPCTwERUJlvn9wlZyMVi9Pr7wdL94w/exec";

/* ===================
   CATALOGO (fácil de editar)
   Adicione/edite items aqui (um por linha)
   =================== */
const CATALOGO = [
  { nome: "Air Fryer", estoque: 1, foto: "img/air_fryer.png" },
  { nome: "Sugar 4 Bocas", estoque: 1, foto: "img/sugar.png" },
   { nome: "Alicate de Crimpagem", estoque: 1, foto: "img/alicate_de_crimpagem.png" },
  { nome: "Aspirador de Pó", estoque: 1, foto: "img/aspirador_de_po.png" },
  { nome: "Assadeira", estoque: 2, foto: "img/assadeira.png" },
  { nome: "Assadeira Redonda", estoque: 2, foto: "img/assadeira_redonda.png" },
  { nome: "Baldes", estoque: 2, foto: "img/baldes.png" },
  { nome: "Batedeira", estoque: 1, foto: "img/batedeira.png" },
  { nome: "Boleira", estoque: 1, foto: "img/boleira.png" },
  { nome: "Cadeira", estoque: 4, foto: "img/cadeira.png" },
  { nome: "Cafeteira", estoque: 1, foto: "img/cafeteira.png" },
  { nome: "Cesta de Pão", estoque: 1, foto: "img/cesta_de_pao.png" },
  { nome: "Conchas", estoque: 1, foto: "img/conhchas.png" },
  { nome: "Conjunto de Bacias", estoque: 1, foto: "img/conjunto_de_bacias.png" },
  { nome: "Conjunto de Banheiro", estoque: 1, foto: "img/conjunto_de_banheiro.png" },
  { nome: "Conjunto de Copos", estoque: 1, foto: "img/conjunto_de_copos.png" },
  { nome: "Conjunto de Garrafas", estoque: 1, foto: "img/conjunto_de_garrafas.png" },
  { nome: "Escorredor de Prato", estoque: 1, foto: "img/escorredor_de_prato.png" },
  { nome: "Espremedor", estoque: 1, foto: "img/espremedor.png" },
  { nome: "Garrafa de Café", estoque: 1, foto: "img/garrafa_de_cafe.png" },
  { nome: "Jarra de Suco", estoque: 1, foto: "img/jarra_de_suco.png" },
  { nome: "Jogo Americano", estoque: 1, foto: "img/jogo_americano.png" },
  { nome: "Jogo de Lençol", estoque: 2, foto: "img/jogo_de_lencol.png" },
  { nome: "Jogo de Taça", estoque: 1, foto: "img/jogo_de_taca.png" },
  { nome: "Jogo de Toalha", estoque: 2, foto: "img/jogo_de_toalha.png" },
  { nome: "Kit Cestos de Lixo", estoque: 1, foto: "img/kit_cestos_de_lixo.png" },
  { nome: "Kit Forma de Bolo Redonda", estoque: 1, foto: "img/kit_de_forma_de_bolo_redonda.png" },
  { nome: "Kit Forma de Bolo Retangular", estoque: 1, foto: "img/kit_de_forma_de_bolo_retangular.png" },
  { nome: "Liquidificador", estoque: 1, foto: "img/liquidificador.png" },
  { nome: "Mop", estoque: 1, foto: "img/mop.png" },
    { nome: "Martelete", estoque: 1, foto: "img/martelete.png" },
  { nome: "Organizador de Talher", estoque: 1, foto: "img/organizador_de_talher.png" },
  { nome: "Panela de Pressão", estoque: 1, foto: "img/panela_de_pressao.png" },
  { nome: "Panela Elétrica de Pressão", estoque: 1, foto: "img/panela_eletrica_de_pressao.png" },
  { nome: "Conjunto de Panelas", estoque: 1, foto: "img/panelas.png" },
  { nome: "Panos de Chão", estoque: 2, foto: "img/panos_de_chao.png" },
  { nome: "Panos de Prato", estoque: 2, foto: "img/panos_de_prato.png" },
  { nome: "Petisqueira", estoque: 1, foto: "img/petisqueira.png" },
  { nome: "Potes", estoque: 1, foto: "img/potes.png" },
  { nome: "Sanduicheira", estoque: 1, foto: "img/sanduicheira.png" },
  { nome: "Conjunto de Pratos", estoque: 1, foto: "img/pratos.png" },
  { nome: "Tábua de Carne", estoque: 1, foto: "img/tabua_de_carne.png" },
  { nome: "Tábua de Frios", estoque: 1, foto: "img/tabua_de_frios.png" },
  { nome: "Talheres", estoque: 1, foto: "img/talheres.png" },
  { nome: "Tapete de Porta", estoque: 1, foto: "img/tapete_de_porta.png" },
  { nome: "Travessa", estoque: 1, foto: "img/travessa.png" },
  { nome: "Travesseiros", estoque: 2, foto: "img/travesseiros.png" },
  { nome: "Triturador de Verduras", estoque: 1, foto: "img/triturador_de_verduras.png" },
  { nome: "Espremedor de Batatas", estoque: 1, foto: "img/espremedor_de_batatas.png" },
  { nome: "Conjunto de Colheres de Pau", estoque: 1, foto: "img/conjuto_colher_de_pau.png" },
  { nome: "Xícaras", estoque: 1, foto: "img/xicaras.png" }
];


/* ===================
   Estado local
   =================== */
let itens = []; // cópia do catálogo + compradores atualizados pela planilha
let selectedIdx = null;
let filtroAtivo = 'todos'; 


  

/* ===================
   Render
   =================== */
function render(){
  const lista = document.getElementById('lista');
  lista.innerHTML = '';

  itens.forEach((it, idx) => {
    const restante = Math.max(0, it.estoque - (it.comprado || 0));
    const esgotado = restante === 0;
    const reservado = (it.comprado || 0) > 0;

    // ===== FILTRO =====
    if (filtroAtivo === 'reservados' && !reservado) return;
    if (filtroAtivo === 'disponiveis' && restante === 0) return;
    // ==================

    const card = document.createElement('div');
    card.className = 'card' + (esgotado ? ' esgotado' : '');

    card.innerHTML = `
      <div class="img-box">
        <img src="${it.foto}" alt="${escapeHtml(it.nome)}">
      </div>

      <div class="row">
        <div class="title">${escapeHtml(it.nome)}</div>
        <div class="qty">${restante} disponível</div>
      </div>

      ${
        reservado
          ? `<div class="buyers">
               <strong>Comprado por:</strong><br>
               ${it.compradores.join('<br>')}
             </div>`
          : ''
      }

      ${
        esgotado
          ? '<div class="btn disabled" aria-disabled="true">Esgotado</div>'
          : `<div class="btn" data-idx="${idx}">Presentear</div>`
      }
    `;

    lista.appendChild(card);
  });

  // eventos dos botões
  document.querySelectorAll('.btn[data-idx]').forEach(btn => {
    btn.addEventListener('click', () => {
      openModal(Number(btn.dataset.idx));
    });
  });

  atualizarContador();
}


  // attach events for buy buttons
  document.querySelectorAll('.btn[data-idx]').forEach(el => {
    el.addEventListener('click', (e) => {
      const idx = Number(el.getAttribute('data-idx'));
      openModal(idx);
    });
  });
       atualizarContador();


/* escape helper */
function escapeHtml(s){ return String(s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ===================
   JSONP loader (carregar dados da planilha)
   - injeta <script src="WEBAPP_URL?callback=cb_...">
   - espera doGet do GAS responder callback({...})
   =================== */
function loadFromSheet(){
  showStatus('Carregando dados...');
  // create unique callback name
  const cb = 'cb_'+Math.floor(Math.random()*9999999);
  window[cb] = function(res){
    try {
      if(!res || res.status !== 'ok'){ showStatus('Erro ao carregar (resposta inválida)'); cleanup(); return; }
      // build local items from catalog copy
      itens = CATALOGO.map(c => ({ nome: c.nome, estoque: c.estoque, foto: c.foto, comprado:0, compradores: [] }));

      // res.rows: [{ts, nome, item, qtd}, ...]
      res.rows.forEach(r => {
        if(!r.item) return;
        const found = itens.find(x => x.nome.trim().toLowerCase() === String(r.item).trim().toLowerCase());
        if(found){
          const q = Number(r.qtd) || 1;
          found.comprado = (found.comprado || 0) + q;
          // show buyer name; if empty, use placeholder
          const buyerName = r.nome && r.nome.trim() ? r.nome.trim() : 'Anônimo';
          found.compradores.push(`${escapeHtml(buyerName)} (${q})`);
        } else {
          // item not in catalog: ignore (or optionally push)
        }
      });

      render();
      showStatus('');
    } catch(e){
      console.error(e);
      showStatus('Erro processando dados');
    } finally { cleanup(); }
    function cleanup(){ const s = document.getElementById(cb+'_script'); if(s) s.remove(); try{ delete window[cb]; }catch{} }
  };

  // inject script tag
  const script = document.createElement('script');
  script.id = cb + '_script';
  const url = new URL(WEBAPP_URL);
  url.searchParams.set('callback', cb);
  url.searchParams.set('action', 'get');
  // append timestamp to avoid aggressive caching
  url.searchParams.set('_t', Date.now());
  script.src = url.toString();
  script.onerror = () => { showStatus('Erro carregando dados (script)'); try{ delete window[cb]; }catch{} };
  document.body.appendChild(script);
}


  document.querySelectorAll('#contador span').forEach(span => {
  span.addEventListener('click', () => {
    filtroAtivo = span.dataset.filter;

    // visual ativo
    document.querySelectorAll('#contador span')
      .forEach(s => s.classList.remove('ativo'));

    span.classList.add('ativo');

    render();
  });
});

  
function atualizarContador(){
  let total = 0;
  let reservados = 0;

  itens.forEach(it => {
    total += it.estoque;
    reservados += (it.comprado || 0);
  });

  const disponiveis = Math.max(0, total - reservados);

  document.getElementById('total-itens').innerText = total;
  document.getElementById('itens-reservados').innerText = reservados;
  document.getElementById('itens-disponiveis').innerText = disponiveis;
}


  
/* ===================
   Modal functions
   =================== */
function openModal(idx){
  selectedIdx = idx;
  const it = itens[idx];
  document.getElementById('modal-title').innerText = it.nome;
  document.getElementById('modal-sub').innerText = `Disponível: ${Math.max(0, it.estoque - (it.comprado||0))}`;
  document.getElementById('input-name').value = ''; 
  document.getElementById('input-qtd').value = 1;
  document.getElementById('modal').style.display = 'flex';
  setTimeout(()=>document.getElementById('input-name').focus(),120);
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }

/* ===================
   Send purchase (POST form-encoded + no-cors)
   =================== */
async function confirmPurchase(){
  const name = document.getElementById('input-name').value.trim();
  const qtd = Math.max(1, Number(document.getElementById('input-qtd').value) || 1);
  if(!name){ alert('Digite seu nome'); return; }
  const it = itens[selectedIdx];
  const available = Math.max(0, it.estoque - (it.comprado||0));
  if(qtd > available){ alert('Quantidade maior que o disponível'); return; }

  // optimistic local update
  it.comprado = (it.comprado||0) + qtd;
  it.compradores.push(`${escapeHtml(name)} (${qtd})`);
  render();
  closeModal();
  showStatus('Enviando...');

  // send form-encoded body using URLSearchParams & no-cors
  const body = new URLSearchParams({ nome: name, item: it.nome, qtd: String(qtd) });
  try {
    await fetch(WEBAPP_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body
    });
    // schedule a refresh to get latest state from sheet
    setTimeout(loadFromSheet, 1200);
    showStatus('Compra registrada (sincronizando...)');
  } catch(err){
    console.warn('fetch no-cors erro:', err);
    showStatus('Erro ao enviar (verifique conexão)');
  }
}

/* ===================
   Helpers
   =================== */
function showStatus(t){ document.getElementById('status').innerText = t || ''; }

/* ===================
   Events
   =================== */
document.getElementById('cancel-btn').addEventListener('click', closeModal);
document.getElementById('confirm-btn').addEventListener('click', confirmPurchase);

/* Close modal on backdrop click */
document.getElementById('modal').addEventListener('click', (e)=>{
  if(e.target === document.getElementById('modal')) closeModal();
});

/* init */
loadFromSheet();
</script>
</body>
</html>










